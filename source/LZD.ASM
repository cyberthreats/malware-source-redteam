;=======================(Code Warez)=========================================
;
; Decompression Stufs.
;
include lzd.ash

;----------------------------------------------------------------------------
;
; TASM Windows model stuff..
;

		.model small, WINDOWS PASCAL
		.386p
		.code
		assume 	ds:@code, es:@code

;
; DS:SI = source.
; ES:DI = dest.
; ES:0..3000h = hash space.
;
PUBLIC		Decompress
Decompress      proc	near

		enter	stack_var_size,0
		movzx	esi,si
		shl	esi,3
		mov	dwo ss:[bp.Bit_Ofs],esi
		call	LZ_Init

	LZD_ml:	call	LZ_ReadCode
		cmp	ax,LZ_EOF
		jne	LZD_ne
		leave
		ret
	LZD_ne:	cmp	ax,LZ_CLEAR
		jne	LZD_nc
		call	LZ_Init
		call	LZ_ReadCode
		mov	dx,ax
		mov	wo ss:[bp.OldCode],ax
		mov	by ss:[bp.FinishChar],al
		stosb
		jmp	LZD_ml
	LZD_nc:	mov	dx,ax
		mov	wo ss:[bp.InCode],ax
		xor	cx,cx
		cmp	ax,wo ss:[bp.FreeCode]
		jl	LZD_nf
		mov	dx,wo ss:[bp.OldCode]
		push	wo ss:[bp.FinishChar]
		inc	cx
	LZD_nf:	cmp	dx,255
		jle	LZD_a
		movzx	ebx,dx
		lea	bx,[ebx + 2*ebx]
		push	wo es:[bx.2]
		inc	cx
		mov	dx,wo es:[bx]
		jmp	LZD_nf
	LZD_a:	mov	by ss:[bp.FinishChar],dl
		push	dx
		inc	cx
	LZD_pl:	pop	ax
		stosb
		loop	LZD_pl
		movzx	ebx,wo ss:[bp.FreeCode]
		push	bx
		lea	bx,[ebx + 2*ebx]
		mov	al,by ss:[bp.FinishChar]
		mov	by es:[bx.2],al
		push	wo ss:[bp.OldCode]
		pop	wo es:[bx]
		inc	wo ss:[bp.FreeCode]
		push	wo ss:[bp.InCode]
		pop	wo ss:[bp.OldCode]
		pop	bx
		inc	bx
		cmp	bx,wo ss:[bp.MaxCode]
		jl	LZD_ml0
		cmp	wo ss:[bp.nBits],12
		je	LZD_ml0
		inc	wo ss:[bp.nBits]
		shl	wo ss:[bp.MaxCode],1
	LZD_ml0:jmp	LZD_ml
				
;---------------
LZ_Init:	mov	wo ss:[bp.FreeCode],LZ_FIRSTFREE
		mov	wo ss:[bp.nBits],9
		mov	wo ss:[bp.MaxCode],512
		ret

;---------------	
LZ_ReadCode:	mov	esi,dwo ss:[bp.Bit_Ofs]
		movzx	eax,wo ss:[bp.nBits]
		push	ax
		add	dwo ss:[bp.Bit_Ofs],eax
		mov	cx,si
		and	cx,7
		shr	esi,3
		lodsw
		xchg	bx,ax
		lodsb
		shrd	bx,ax,cl
		pop	cx
		mov	al,1
		shl	ax,cl
		dec	ax
		and	ax,bx
		ret

Decompress	endp
		end
;============================================================================
